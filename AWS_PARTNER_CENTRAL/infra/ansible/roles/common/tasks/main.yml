---
# Common role - base packages and configuration

- name: Update apt cache
  apt:
    update_cache: true
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- name: Install common packages
  apt:
    name: "{{ common_packages }}"
    state: present
  when: ansible_os_family == "Debian"

- name: Set timezone to UTC
  timezone:
    name: UTC

- name: Configure sysctl for networking
  sysctl:
    name: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
    reload: true
  loop:
    - { key: "net.core.somaxconn", value: "65535" }
    - { key: "net.ipv4.tcp_max_syn_backlog", value: "65535" }
    - { key: "net.ipv4.tcp_tw_reuse", value: "1" }
  tags: [sysctl]

- name: Ensure journald is configured
  lineinfile:
    path: /etc/systemd/journald.conf
    regexp: "^#?{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
  loop:
    - { key: "SystemMaxUse", value: "1G" }
    - { key: "MaxRetentionSec", value: "1week" }
  notify: restart journald

- name: Configure logrotate for custom logs
  copy:
    content: |
      /var/log/pcw/*.log {
          daily
          missingok
          rotate 14
          compress
          delaycompress
          notifempty
          create 0640 root adm
      }
    dest: /etc/logrotate.d/pcw
    mode: '0644'

handlers:
  - name: restart journald
    service:
      name: systemd-journald
      state: restarted
