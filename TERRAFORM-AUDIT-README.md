# Terraform State Audit System

## Overview

This system provides automated auditing of your Terraform-managed infrastructure against actual AWS resources. It identifies resources that exist in AWS but are **not managed by Terraform**, generating a comprehensive diff report and ready-to-use import commands.

## Purpose

- **Identify Drift**: Find resources created outside of Terraform (manual AWS Console, CLI, or other tools)
- **Import Planning**: Generate prioritized terraform import commands for unmanaged resources
- **Coverage Analysis**: Understand what percentage of your AWS infrastructure is managed by Terraform
- **Compliance**: Ensure all infrastructure follows Infrastructure as Code principles

## Quick Start

```bash
# Prerequisites: Run AWS resource discovery first
./scripts/aws-resource-discovery.sh

# Run Terraform audit
./scripts/terraform-audit.sh --generate-imports

# Review the report
cat terraform-audit-report.json | jq '.summary'

# Execute import commands (review first!)
./terraform-audit-report-imports.sh
```

## How It Works

### 1. Discovery Phase
The audit script:
- Scans all Terraform workspace directories in the repository
- Parses `terraform.tfstate` files to extract managed resources
- Loads the AWS inventory (generated by `aws-resource-discovery.sh`)

### 2. Comparison Phase
For each resource in the AWS inventory:
- Checks if the resource ID exists in any Terraform state
- Maps AWS service types to Terraform resource types
- Identifies unmanaged resources

### 3. Report Generation
Creates a comprehensive JSON report with:
- **Summary statistics**: Total resources, coverage percentage, unmanaged count
- **Terraform state details**: All managed resources by workspace
- **Unmanaged resources**: Organized by service with import commands
- **Import plan**: Prioritized terraform import commands (high/medium/low)

## Usage

### Basic Audit

```bash
./scripts/terraform-audit.sh
```

### With Custom Inventory File

```bash
./scripts/terraform-audit.sh --inventory path/to/aws-inventory.json
```

### Generate Import Script

```bash
./scripts/terraform-audit.sh --generate-imports
```

This creates `terraform-audit-report-imports.sh` with all import commands.

### Audit Specific Workspace

```bash
./scripts/terraform-audit.sh --workspace ./infrastructure/terraform/core
```

### Verbose Output

```bash
./scripts/terraform-audit.sh --verbose
```

## Audit Report Structure

The `terraform-audit-report.json` file contains:

```json
{
  "metadata": {
    "generated_at": "2026-01-24T16:50:00Z",
    "terraform_workspaces": ["workspace1", "workspace2"],
    "aws_inventory_file": "./aws-inventory.json",
    "account_id": "313476888312",
    "version": "1.0.0"
  },
  "summary": {
    "total_aws_resources": 145,
    "total_terraform_managed": 518,
    "total_unmanaged": 80,
    "total_orphaned": 0,
    "coverage_percentage": 357.00
  },
  "terraform_state": {
    "workspaces": [...]
  },
  "unmanaged_resources": {
    "by_service": {
      "compute": [...],
      "database": [...],
      "storage": [...]
    },
    "total_count": 80
  },
  "import_plan": {
    "high_priority": [...],
    "medium_priority": [...],
    "low_priority": [...]
  }
}
```

## Unmanaged Resource Entry

Each unmanaged resource includes:

```json
{
  "resource_id": "firespring-backdoor-orchestrator-dev",
  "resource_type_terraform": "aws_lambda_function",
  "terraform_address": "aws_lambda_function.firespring-backdoor-orchestrator-dev",
  "import_command": "terraform import aws_lambda_function.firespring-backdoor-orchestrator-dev firespring-backdoor-orchestrator-dev",
  "resource_data": {
    "function_name": "firespring-backdoor-orchestrator-dev",
    "runtime": "nodejs20.x",
    "last_modified": "2025-12-24T11:10:13.438+0000",
    "memory_size": 512,
    "timeout": 300,
    "arn": "arn:aws:lambda:us-east-1:313476888312:function:firespring-backdoor-orchestrator-dev"
  }
}
```

## Import Priority Levels

### High Priority (Import First)
- **VPCs and Networking**: Core infrastructure that other resources depend on
- **IAM Roles and Policies**: Security and access control
- **DynamoDB Tables**: Database resources
- **KMS Keys**: Encryption keys

### Medium Priority (Import Second)
- **Lambda Functions**: Application code
- **ECS Clusters and Services**: Container orchestration
- **S3 Buckets**: Object storage
- **Load Balancers and API Gateways**: Traffic routing

### Low Priority (Import Last)
- **CloudWatch Log Groups**: Monitoring and logging
- **EventBridge Rules**: Event-driven automation
- **SNS Topics and SQS Queues**: Messaging

## Resource Type Mapping

The audit script automatically maps AWS inventory types to Terraform resource types:

| AWS Service | Resource Type | Terraform Type |
|-------------|---------------|----------------|
| Lambda Functions | lambda_functions | aws_lambda_function |
| DynamoDB Tables | dynamodb_tables | aws_dynamodb_table |
| S3 Buckets | s3_buckets | aws_s3_bucket |
| EC2 Instances | ec2_instances | aws_instance |
| VPCs | vpcs | aws_vpc |
| ECS Clusters | ecs_clusters | aws_ecs_cluster |
| API Gateways | api_gateways | aws_api_gateway_rest_api |
| Load Balancers | load_balancers | aws_lb |
| IAM Roles | iam_roles | aws_iam_role |
| KMS Keys | kms_keys | aws_kms_key |
| Secrets Manager | secrets | aws_secretsmanager_secret |
| CloudWatch Logs | cloudwatch_log_groups | aws_cloudwatch_log_group |
| EventBridge Rules | eventbridge_rules | aws_cloudwatch_event_rule |

## Importing Resources

### Step 1: Review the Import Script

```bash
cat terraform-audit-report-imports.sh
```

Review the commands to ensure they're targeting the correct workspace.

### Step 2: Prepare Terraform Configuration

Before importing, you need to create Terraform resource blocks:

```hcl
# Example: infrastructure/terraform/core/lambda.tf
resource "aws_lambda_function" "firespring-backdoor-orchestrator-dev" {
  # Configuration will be populated after import
  # Leave empty for now
}
```

### Step 3: Navigate to Appropriate Workspace

```bash
cd infrastructure/terraform/core
```

### Step 4: Initialize Terraform

```bash
terraform init
```

### Step 5: Import Resources

```bash
# Import a single resource
terraform import aws_lambda_function.firespring-backdoor-orchestrator-dev firespring-backdoor-orchestrator-dev

# Or run all high priority imports
grep "^terraform import" ../../../terraform-audit-report-imports.sh | \
  grep "HIGH PRIORITY" -A 100 | \
  grep "^terraform" | \
  bash
```

### Step 6: Generate Configuration from State

After importing, use `terraform show` to see the imported configuration:

```bash
terraform show -json | jq '.values.root_module.resources[] | select(.address == "aws_lambda_function.firespring-backdoor-orchestrator-dev")'
```

### Step 7: Update Terraform Files

Copy the relevant attributes from `terraform show` into your `.tf` files.

### Step 8: Verify

```bash
terraform plan
```

Should show **no changes** if import was successful and configuration is complete.

## Querying the Audit Report

### Count Unmanaged Resources by Service

```bash
jq '.unmanaged_resources.by_service | to_entries | map({service: .key, count: (.value | length)})' terraform-audit-report.json
```

### List All Unmanaged Lambda Functions

```bash
jq '.unmanaged_resources.by_service.compute[] | select(.resource_type_terraform == "aws_lambda_function") | .resource_id' terraform-audit-report.json
```

### Show High Priority Import Commands

```bash
jq -r '.import_plan.high_priority[]' terraform-audit-report.json
```

### Find Unmanaged Resources by Name Pattern

```bash
jq '.unmanaged_resources.by_service[] | .[] | select(.resource_id | contains("firespring"))' terraform-audit-report.json
```

## Workflow Integration

### Daily Audit (Cron)

```bash
# Add to crontab
crontab -e

# Run audit daily at 3 AM (after AWS discovery at 2 AM)
0 3 * * * cd /home/daclab-ai/DEV/AWS-DevOps && ./scripts/terraform-audit.sh --generate-imports
```

### Pre-Commit Hook

Create `.git/hooks/pre-commit`:

```bash
#!/bin/bash
# Run Terraform audit before commit
./scripts/terraform-audit.sh --output /tmp/tf-audit.json

UNMANAGED=$(jq -r '.summary.total_unmanaged' /tmp/tf-audit.json)

if [[ "$UNMANAGED" -gt 100 ]]; then
    echo "WARNING: $UNMANAGED unmanaged resources detected!"
    echo "Consider running: ./terraform-audit-report-imports.sh"
fi
```

### CI/CD Pipeline

```yaml
# .github/workflows/terraform-audit.yml
name: Terraform Audit

on:
  schedule:
    - cron: '0 3 * * *'  # Daily at 3 AM

jobs:
  audit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Run AWS Discovery
        run: ./scripts/aws-resource-discovery.sh

      - name: Run Terraform Audit
        run: ./scripts/terraform-audit.sh --generate-imports

      - name: Upload Audit Report
        uses: actions/upload-artifact@v2
        with:
          name: terraform-audit-report
          path: terraform-audit-report.json

      - name: Check Coverage
        run: |
          COVERAGE=$(jq -r '.summary.coverage_percentage' terraform-audit-report.json)
          echo "Terraform Coverage: ${COVERAGE}%"

          if (( $(echo "$COVERAGE < 50.0" | bc -l) )); then
            echo "::warning::Terraform coverage below 50%"
          fi
```

## Understanding Coverage Percentage

The coverage percentage can exceed 100% when:
- Terraform manages data sources (read-only resources)
- Multiple Terraform resource instances reference the same AWS resource
- Terraform state includes resources from multiple regions/accounts

A more accurate metric is:
```
Actual Coverage = (total_terraform_managed - data_sources) / total_aws_resources * 100
```

## Troubleshooting

### "Argument list too long" Error

The script uses temp files to avoid this issue. If you still encounter it:
1. Ensure `/tmp` has sufficient space
2. Check `ulimit -s` (stack size)
3. Process workspaces individually with `--workspace`

### Import Fails

Common reasons:
1. **Resource already imported**: Check if resource exists in a different workspace
2. **Incorrect identifier**: Verify the resource ID format for that resource type
3. **Missing permissions**: Ensure AWS credentials have read access
4. **Resource deleted**: The AWS inventory may be outdated

### High Number of Unmanaged Resources

This is common if:
- Resources were created before Terraform adoption
- Multiple teams manage infrastructure
- Some resources are managed by other IaC tools (CloudFormation, CDK)

## Best Practices

1. **Run Discovery First**: Always run `aws-resource-discovery.sh` before the audit
2. **Review Before Importing**: Manually review import commands before execution
3. **Import by Priority**: Start with high-priority resources (VPCs, IAM, databases)
4. **Test Imports**: Import to a test workspace first to verify configuration
5. **Document Exclusions**: Some resources (like AWS-managed) should remain unmanaged
6. **Regular Audits**: Schedule weekly audits to catch drift early
7. **Team Coordination**: Coordinate with team before mass imports

## Limitations

### Not Detected
- **Data sources**: Terraform data sources are read-only and don't manage resources
- **AWS-managed resources**: Default VPCs, security groups, etc.
- **Implicit resources**: Some resources created automatically by AWS

### Resource Types
The script currently supports 20+ AWS resource types. Additional types can be added by:
1. Adding mapping in `get_terraform_resource_type()`
2. Adding identifier extraction in `get_resource_identifier()`

### Cross-Account
Currently audits only the current AWS account. For multi-account:
- Run separate audits per account
- Aggregate reports manually

## Extending the Script

### Add New Resource Type

1. Update `get_terraform_resource_type()`:
```bash
"service:resource_type") echo "aws_terraform_type" ;;
```

2. Update `get_resource_identifier()`:
```bash
"aws_terraform_type")
    echo "$resource_data" | jq -r '.identifier_field'
    ;;
```

3. Update `get_import_priority()` if needed:
```bash
aws_terraform_type)
    echo "high" ;;
```

## Output Files

- **terraform-audit-report.json**: Main audit report (1-2 MB typically)
- **terraform-audit-report-imports.sh**: Executable import script
- **Temp files**: `/tmp/terraform_audit_*.json` (auto-cleaned)

## Support

For issues or questions:
- Review the audit report: `jq . terraform-audit-report.json | less`
- Run with `--verbose` to see detailed progress
- Check Terraform state files exist and are valid JSON
- Verify AWS inventory is current

## Version History

- **1.0.0** (2026-01-24): Initial release
  - Support for 20+ AWS resource types
  - Multi-workspace auditing
  - Prioritized import plan generation
  - Automated import script creation
  - Comprehensive diff reporting
